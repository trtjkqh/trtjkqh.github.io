<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>成品信息查询</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 小调整，让表格在桌面端看起来更紧凑 */
    .table-fixed th, .table-fixed td { white-space: nowrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-semibold">成品信息查询</h1>
        <p class="text-sm text-gray-500">在 CP 目录下放置 data.json（与本文件同级），输入项目号（精确）和/或品名（模糊）进行查询。</p>
      </div>
      <div class="text-sm text-gray-500">数据文件：<code class="bg-white px-2 py-1 rounded">CP/data.json</code></div>
    </header>

    <!-- 搜索区 -->
    <section class="bg-white p-4 rounded shadow-sm mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-gray-600">项目号（精确）</label>
          <input id="projectInput" type="text" placeholder="例如：XM-2025-001" class="mt-1 block w-full border border-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div>
          <label class="text-sm text-gray-600">品名（模糊）</label>
          <input id="nameInput" type="text" placeholder="可输入部分品名进行模糊搜索" class="mt-1 block w-full border border-gray-200 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex items-end gap-2">
          <button id="searchBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">查询</button>
          <button id="clearBtn" class="px-4 py-2 border border-gray-300 rounded">清空</button>
          <button id="exportBtn" class="px-4 py-2 border border-gray-300 rounded">导出 CSV</button>
        </div>
      </div>
    </section>

    <!-- 结果区 -->
    <section id="resultSection" class="bg-white p-4 rounded shadow-sm">
      <div id="count" class="text-sm text-gray-600 mb-2">加载中…</div>
      <div class="overflow-x-auto">
        <table id="resultTable" class="min-w-full divide-y divide-gray-200 table-fixed">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">项目号</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">品名</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">规格</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">单位</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">零售价</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">产品属性</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">保质期</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">品牌</th>
              <th class="px-3 py-2 text-left text-sm font-medium text-gray-700">可供应渠道</th>
            </tr>
          </thead>
          <tbody id="tbody" class="bg-white divide-y divide-gray-100">
            <!-- JS 动态填充 -->
          </tbody>
        </table>
      </div>
      <div id="noData" class="hidden text-center text-gray-500 py-6">未找到匹配结果。</div>
    </section>

    <!-- 详情模态 -->
    <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
      <div class="bg-white rounded shadow-lg max-w-xl w-full p-4">
        <div class="flex justify-between items-center mb-2">
          <h3 id="modalTitle" class="text-lg font-medium">产品详情</h3>
          <button id="closeModal" class="text-gray-500">关闭</button>
        </div>
        <div id="modalBody" class="text-sm text-gray-700">
          <!-- 动态内容 -->
        </div>
      </div>
    </div>

    <footer class="mt-4 text-xs text-gray-500">提示：项目号为精确匹配（未输入则忽略），品名支持模糊搜索（区分大小写可选，默认不区分）。</footer>
  </div>

  <script>
    /*
      期望 data.json 的示例结构（放在 CP/data.json）：
      [
        {
          "项目号": "XM-2025-001",
          "品名": "鲜冬虫夏草-2A",
          "规格": "2A（0.61g-0.8g/支）-27",
          "单位": "支",
          "零售价": "¥120",
          "产品属性": "保健食品",
          "保质期": "24个月",
          "品牌": "地平线",
          "可供应渠道": "自有库存, 线上经销"
        },
        ...
      ]
    */

    let data = [];

    async function loadData() {
      try {
        const res = await fetch('./data.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('无法加载 data.json: ' + res.status);
        data = await res.json();
        document.getElementById('count').textContent = `共 ${data.length} 条记录（已加载）`;
        renderTable(data.slice(0, 100)); // 初始展示前 100 条，避免一次塞太多
      } catch (e) {
        console.error(e);
        document.getElementById('count').textContent = '加载 data.json 失败，请确认文件位置为 CP/data.json 且为合法 JSON。';
        document.getElementById('noData').classList.remove('hidden');
      }
    }

    function renderTable(list) {
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      if (!list || list.length === 0) {
        document.getElementById('noData').classList.remove('hidden');
        return;
      }
      document.getElementById('noData').classList.add('hidden');
      for (const row of list) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${row['项目号'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['品名'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['规格'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['单位'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['零售价'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['产品属性'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['保质期'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['品牌'] ?? ''}</td>
          <td class="px-3 py-2 text-sm">${row['可供应渠道'] ?? ''}</td>
        `;
        tr.addEventListener('click', () => showDetail(row));
        tbody.appendChild(tr);
      }
    }

    function showDetail(row) {
      document.getElementById('modalTitle').textContent = row['品名'] || '产品详情';
      const body = document.getElementById('modalBody');
      body.innerHTML = Object.entries(row).map(([k, v]) => `
        <div class="mb-2"><span class="text-gray-600">${k}：</span><span class="font-medium">${v}</span></div>
      `).join('');
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('modal').classList.add('flex');
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('modal').classList.remove('flex');
    }

    function doSearch() {
      const project = document.getElementById('projectInput').value.trim();
      const name = document.getElementById('nameInput').value.trim();

      // 项目号为精确匹配：如果填写了项目号，以项目号为主（精确匹配），否则根据品名模糊
      let results = data;
      if (project) {
        results = results.filter(r => (r['项目号'] ?? '').toString() === project);
      }
      if (name) {
        const n = name.toLowerCase();
        results = results.filter(r => (r['品名'] ?? '').toString().toLowerCase().includes(n));
      }

      document.getElementById('count').textContent = `匹配到 ${results.length} 条`;
      renderTable(results);
    }

    function clearInputs() {
      document.getElementById('projectInput').value = '';
      document.getElementById('nameInput').value = '';
      document.getElementById('count').textContent = `共 ${data.length} 条记录（已加载）`;
      renderTable(data.slice(0, 100));
    }

    function exportCSV() {
      const rows = Array.from(document.querySelectorAll('#tbody tr'));
      if (!rows.length) return alert('当前没有可导出的数据。');
      const header = ['项目号','品名','规格','单位','零售价','产品属性','保质期','品牌','可供应渠道'];
      const csv = [header.join(',')];
      for (const tr of rows) {
        const cells = Array.from(tr.querySelectorAll('td')).map(td => '"' + (td.textContent.replaceAll('"','""')) + '"');
        csv.push(cells.join(','));
      }
      const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cp_query_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('searchBtn').addEventListener('click', doSearch);
    document.getElementById('clearBtn').addEventListener('click', clearInputs);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });

    // 支持回车触发查询
    document.getElementById('projectInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
    document.getElementById('nameInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

    // 启动时加载数据
    loadData();
  </script>
</body>
</html>
