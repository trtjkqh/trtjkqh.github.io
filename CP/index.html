<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆå“ä¿¡æ¯æŸ¥è¯¢</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { background-color:#f3f4f6; }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
.fade-in { animation: fadeIn 0.3s ease-in-out; }

table { border-collapse:collapse; width:100%; background:white; font-size:0.9rem; }
th, td { border:1px solid #e5e7eb; padding:0.5rem; text-align:center; }
th { background:#e0f2fe; color:#1e3a8a; font-weight:600; cursor:pointer; position:sticky; top:0; z-index:10; }
tr:hover { background:#f0f9ff; }
.sort-asc::after { content:" â†‘"; color:#0d6efd; }
.sort-desc::after { content:" â†“"; color:#0d6efd; }
</style>
</head>
<body class="p-6">

<!-- Header -->
<div class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-4 flex flex-col md:flex-row justify-between fade-in mb-6">
  <div class="flex items-center gap-3">
    <img src="/assets/img/trtlogo.png" class="h-12 object-contain">
    <div>
      <h1 class="text-2xl font-bold text-gray-700">æˆå“ä¿¡æ¯æŸ¥è¯¢</h1>
      <p class="text-sm text-gray-500">è¾“å…¥æ¡ä»¶åæŸ¥è¯¢</p>
    </div>
  </div>
  <div class="flex flex-col md:flex-row items-center gap-2">
    <span class="px-2 py-1 bg-yellow-50 border rounded text-yellow-700">ğŸ” æ•°æ®ï¼š2025å¹´7æœˆ</span>
    <span class="px-2 py-1 bg-red-50 border rounded font-semibold text-red-600">âš ï¸ ä¿å¯†ï¼šå†…éƒ¨æ•°æ®ä¸¥ç¦å¤–ä¼ </span>
  </div>
</div>

<!-- Search box -->
<div class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-6 fade-in mb-6 space-y-4">
<div class="flex flex-wrap gap-3">
  <select id="channelSelect" class="border rounded-lg p-2 min-w-[150px]">
    <option value="">æ‰€æœ‰æ¸ é“</option>
  </select>
  <input id="projectInput" placeholder="é¡¹ç›®å·ï¼ˆç²¾å‡†ï¼‰" class="border rounded-lg p-2 flex-1 min-w-[150px]">
  <input id="nameInput" placeholder="å“åï¼ˆæ¨¡ç³Šæœç´¢ï¼‰" class="border rounded-lg p-2 flex-1 min-w-[150px]">

  <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">æŸ¥è¯¢</button>
  <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">å¯¼å‡ºExcel</button>
</div>

<!-- Result table -->
<div class="overflow-auto max-h-[70vh] border rounded-lg mt-4">
<table id="resultTable" class="hidden fade-in">
<thead>
<tr>
  <th data-sort="åºå·">åºå·</th>
  <th data-sort="é¡¹ç›®å·">é¡¹ç›®å·</th>
  <th data-sort="å“å">å“å</th>
  <th data-sort="è§„æ ¼">è§„æ ¼</th>
  <th data-sort="å•ä½">å•ä½</th>
  <th data-sort="é›¶å”®ä»·">é›¶å”®ä»·</th>
  <th data-sort="å“ç‰Œ">å“ç‰Œ</th>
  <th data-sort="å¯ä¾›åº”æ¸ é“">æ¸ é“</th>
  <th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<p id="noResult" class="text-center text-gray-500 mt-2 hidden">æœªæ‰¾åˆ°è®°å½•</p>
</div>

<!-- BOM å±•ç¤ºåŒº -->
<div id="bomArea" class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl p-6 fade-in mb-6 hidden">
  <h2 class="text-lg font-bold text-gray-700 mb-4">é¡¹ç›® BOM</h2>
  <button id="closeBOM" class="mb-4 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">å…³é—­</button>
  <div class="overflow-auto max-h-[50vh] border rounded-lg">
    <table id="bomTable" class="w-full text-sm border-collapse">
      <thead>
        <tr class="bg-blue-100">
          <th class="border px-2 py-1">åºå·</th>
          <th class="border px-2 py-1">ç‰©æ–™é¡¹ç›®å·</th>
          <th class="border px-2 py-1">ç‰©æ–™åç§°</th>
          <th class="border px-2 py-1">æ•°é‡</th>
          <th class="border px-2 py-1">è®¡é‡å•ä½</th>
          <th class="border px-2 py-1">é‡‡è´­å•ä»·</th>
        </tr>
      </thead>
      <tbody id="bomTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Footer -->
<footer class="text-center text-gray-500 text-sm mt-6">
Â© 2025 é‡‡è´­éƒ¨ | <a href="/CP/index.html">æˆå“ä¿¡æ¯</a> | <a href="/product/index.html">äº§å“æ‰‹å†Œ</a>
</footer>

<script>
let allData = [], currentData = [];
let bomData = [], czData = [];
let sortDirection = {};

// åŠ è½½ CP æ•°æ®
fetch("data.json").then(r=>r.json()).then(data=>{
  allData = data;
  const select=document.getElementById("channelSelect");
  [...new Set(data.map(i=>i.å¯ä¾›åº”æ¸ é“).filter(Boolean))].forEach(c=>{
    select.innerHTML += `<option>${c}</option>`;
  });
});

// åŠ è½½ BOM æ•°æ®
fetch("../bom/bom_data.json").then(r=>r.json()).then(data=>{ bomData=data; });

// åŠ è½½é‡‡è´­å•ä»·æ•°æ®
fetch("../cz/data.json").then(r=>r.json()).then(data=>{ czData=data; });

// æŸ¥è¯¢å‡½æ•°
function search(){
  const p=document.getElementById("projectInput").value.trim();
  const n=document.getElementById("nameInput").value.trim();
  const c=document.getElementById("channelSelect").value;

  currentData = allData.filter(i =>
    (!p || String(i.é¡¹ç›®å·)===p) &&
    (!n || i.å“å.includes(n)) &&
    (!c || i.å¯ä¾›åº”æ¸ é“===c)
  );

  renderTable();
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable(){
  const table=document.getElementById("resultTable");
  const tbody=document.getElementById("tableBody");
  const no=document.getElementById("noResult");

  if(!currentData.length){
    table.classList.add("hidden");
    no.classList.remove("hidden");
    return;
  }

  no.classList.add("hidden");
  table.classList.remove("hidden");

  tbody.innerHTML = currentData.map((i,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${i.é¡¹ç›®å·||""}</td>
      <td>${i.å“å||""}</td>
      <td>${i.è§„æ ¼||""}</td>
      <td>${i.å•ä½||""}</td>
      <td>${i.é›¶å”®ä»·??""}</td>
      <td>${i.å“ç‰Œ||""}</td>
      <td>${i.å¯ä¾›åº”æ¸ é“||""}</td>
      <td><button class="text-blue-600 hover:underline" onclick="showBOM(${i.é¡¹ç›®å·})">æŸ¥çœ‹BOM</button></td>
    </tr>
  `).join("");
}

// æ’åº
document.querySelectorAll("th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const key = th.dataset.sort;
    if(key==="åºå·") return;
    sortDirection[key] = !sortDirection[key];

    currentData.sort((a,b)=>{
      const x = a[key] ?? "";
      const y = b[key] ?? "";
      if(key === "é›¶å”®ä»·") return sortDirection[key] ? (x-y) : (y-x);
      return sortDirection[key] ? String(x).localeCompare(String(y)) : String(y).localeCompare(String(x));
    });

    document.querySelectorAll("th").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
    th.classList.add(sortDirection[key]?"sort-asc":"sort-desc");
    renderTable();
  });
});

// å¯¼å‡º Excel
document.getElementById("exportBtn").onclick=()=>{
  if(!currentData.length) return alert("æš‚æ— æ•°æ®");
  const data=currentData.map((i,idx)=>({
    åºå·:idx+1, é¡¹ç›®å·:i.é¡¹ç›®å·, å“å:i.å“å, è§„æ ¼:i.è§„æ ¼,
    å•ä½:i.å•ä½, é›¶å”®ä»·:i.é›¶å”®ä»·??"", å“ç‰Œ:i.å“ç‰Œ, æ¸ é“:i.å¯ä¾›åº”æ¸ é“
  }));

  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"æˆå“æŸ¥è¯¢ç»“æœ");
  XLSX.writeFile(wb,"æˆå“æŸ¥è¯¢.xlsx");
};

// æ˜¾ç¤º BOM
function showBOM(projectNo){
  const items = bomData.filter(item => Number(item.é¡¹ç›®å·) === Number(projectNo));
  if(items.length===0){ alert("æœªæ‰¾åˆ°å¯¹åº” BOM"); return; }
  const bomTableBody = document.getElementById("bomTableBody");
  const bomArea = document.getElementById("bomArea");

  bomTableBody.innerHTML = items.map((i,idx)=>{
    const czItem = czData.find(c=>String(c.ç‰©æ–™é¡¹ç›®å·) === String(i.ç‰©æ–™é¡¹ç›®å·));
    const price = czItem ? czItem.é‡‡è´­å•ä»· : '';
    return `<tr>
      <td class="border px-2 py-1">${idx+1}</td>
      <td class="border px-2 py-1">${i.ç‰©æ–™é¡¹ç›®å·||''}</td>
      <td class="border px-2 py-1">${i.ç‰©æ–™åç§°||''}</td>
      <td class="border px-2 py-1">${i.æ•°é‡||''}</td>
      <td class="border px-2 py-1">${i.è®¡é‡å•ä½||''}</td>
      <td class="border px-2 py-1">${price}</td>
    </tr>`;
  }).join('');
  bomArea.classList.remove("hidden");
}

// å…³é—­ BOM
document.getElementById("closeBOM").onclick = ()=>{
  document.getElementById("bomArea").classList.add("hidden");
};

// å›è½¦è§¦å‘æŸ¥è¯¢
document.addEventListener("keydown", e=>{ if(e.key==="Enter") search(); });
document.getElementById("searchBtn").onclick = search;
</script>

</body>
</html>
