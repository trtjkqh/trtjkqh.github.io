<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆå“ä¿¡æ¯æŸ¥è¯¢</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  .fade-in { animation: fadeIn 0.4s ease-in; }
  table th { position: sticky; top: 0; background-color: white; z-index: 10; }
</style>
</head>

<body class="bg-gray-50 font-sans text-gray-800">

<!-- ä¸»å†…å®¹ -->
<div id="mainContent" class="transition-opacity duration-500">

  <!-- æŸ¥è¯¢åŒºåŸŸ -->
  <div class="max-w-7xl mx-auto bg-white shadow rounded-xl p-6 mb-6 flex flex-wrap gap-3 items-center fade-in">
    <select id="channelSelect" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400">
      <option value="">æ‰€æœ‰æ¸ é“</option>
    </select>
    <input id="projectInput" type="text" placeholder="é¡¹ç›®å·ï¼ˆç²¾å‡†ï¼‰" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />
    <input id="nameInput" type="text" placeholder="å“åï¼ˆæ¨¡ç³Šæœç´¢ï¼‰" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />

    <button id="searchBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition shadow">æŸ¥è¯¢</button>
    <button id="resetBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition shadow">é‡ç½®</button>
    <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition shadow">å¯¼å‡ºExcel</button>
  </div>

  <!-- ç»“æœåŒºåŸŸ -->
  <div id="loading" class="text-center text-red-600 font-medium my-6 fade-in hidden">â³ æ•°æ®åŠ è½½ä¸­...</div>
  <div id="resultContainer" class="max-w-7xl mx-auto overflow-x-auto fade-in">
    <table id="resultTable" class="hidden w-full text-sm text-center border border-gray-200 rounded-lg shadow-sm">
      <thead class="bg-gray-100 font-semibold">
        <tr>
          <th class="p-2 border-b">åºå·</th>
          <th class="p-2 border-b">é¡¹ç›®å·</th>
          <th class="p-2 border-b">å“å</th>
          <th class="p-2 border-b">è§„æ ¼</th>
          <th class="p-2 border-b">å•ä½</th>
          <th class="p-2 border-b">é›¶å”®ä»·</th>
          <th class="p-2 border-b">å“ç‰Œ</th>
          <th class="p-2 border-b">æ¸ é“</th>
          <th class="p-2 border-b">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <p id="noResult" class="text-center text-gray-500 mt-4 hidden">æœªæ‰¾åˆ°è®°å½•</p>
  </div>

  <!-- BOM åŒºåŸŸ -->
  <div id="bomSection" class="max-w-7xl mx-auto mt-8 hidden p-6 bg-white shadow rounded-xl fade-in">
    <h2 class="text-lg font-semibold mb-4 text-gray-700">ğŸ“¦ BOMæ˜ç»†</h2>
    <table id="bomTable" class="w-full text-sm text-center border border-gray-200 rounded-lg shadow-sm">
      <thead class="bg-gray-100 font-semibold">
        <tr>
          <th class="p-2 border-b">ç‰©æ–™é¡¹ç›®å·</th>
          <th class="p-2 border-b">ç‰©æ–™åç§°</th>
          <th class="p-2 border-b">æ•°é‡</th>
          <th class="p-2 border-b">è®¡é‡å•ä½</th>
          <th class="p-2 border-b">é‡‡è´­å•ä»·</th>
        </tr>
      </thead>
      <tbody id="bomBody"></tbody>
    </table>
  </div>

</div>

<script>
let allData=[], currentData=[], bomData=[], czData=[];
let sortDirection={};

// è‡ªåŠ¨å°è¯•åŠ è½½ï¼ˆé˜²æ­¢è·¯å¾„é—®é¢˜ï¼‰
async function safeFetch(urls){
  for(const url of urls){
    try{
      const r=await fetch(url);
      if(r.ok) return await r.json();
    }catch(e){}
  }
  return [];
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
document.getElementById("loading").classList.remove("hidden");

Promise.all([
  safeFetch(["data.json","./data.json"]),
  safeFetch(["../bom/bom_data.json","/bom/bom_data.json","bom/bom_data.json"]),
  safeFetch(["../cz/data.json","/cz/data.json","cz/data.json"])
]).then(([a,b,c])=>{
  allData=a; bomData=b; czData=c;
  const select=document.getElementById("channelSelect");
  [...new Set(a.map(i=>i.å¯ä¾›åº”æ¸ é“).filter(Boolean))].forEach(c=>{
    select.innerHTML+=`<option>${c}</option>`;
  });
  document.getElementById("loading").classList.add("hidden");
  console.log("âœ… æ•°æ®åŠ è½½å®Œæˆ", {allData,bomData,czData});
});

function search(){
  const p=document.getElementById("projectInput").value.trim();
  const n=document.getElementById("nameInput").value.trim();
  const c=document.getElementById("channelSelect").value;
  currentData=allData.filter(i=>
    (!p || String(i.é¡¹ç›®å·)===p) &&
    (!n || i.å“å.includes(n)) &&
    (!c || i.å¯ä¾›åº”æ¸ é“===c)
  );
  renderTable();
}

function resetForm() {
  document.getElementById("channelSelect").value = "";
  document.getElementById("projectInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("resultTable").classList.add("hidden");
  document.getElementById("noResult").classList.add("hidden");
  document.getElementById("bomSection").classList.add("hidden");
}

function renderTable(){
  const tbody=document.getElementById("tableBody");
  const table=document.getElementById("resultTable");
  const no=document.getElementById("noResult");

  if(!currentData.length){
    table.classList.add("hidden");
    no.classList.remove("hidden");
    return;
  }

  no.classList.add("hidden");
  table.classList.remove("hidden");

  tbody.innerHTML=currentData.map((i,idx)=>{
    const rowClass = idx % 2 === 0 ? 'bg-gray-50' : 'bg-white';
    return `
      <tr class="${rowClass} hover:bg-red-50 transition">
        <td class="p-2 border-b">${idx+1}</td>
        <td class="p-2 border-b">${i.é¡¹ç›®å·}</td>
        <td class="p-2 border-b">${i.å“å}</td>
        <td class="p-2 border-b">${i.è§„æ ¼}</td>
        <td class="p-2 border-b">${i.å•ä½}</td>
        <td class="p-2 border-b">${i.é›¶å”®ä»·||""}</td>
        <td class="p-2 border-b">${i.å“ç‰Œ||""}</td>
        <td class="p-2 border-b">${i.å¯ä¾›åº”æ¸ é“||""}</td>
        <td class="p-2 border-b"><button onclick="showBOM('${i.é¡¹ç›®å·}')" class="text-blue-600 hover:underline">æŸ¥çœ‹BOM</button></td>
      </tr>`;
  }).join("");
}

function showBOM(projectId){
  const section=document.getElementById("bomSection");
  const tbody=document.getElementById("bomBody");
  const list=bomData.filter(i=>String(i.é¡¹ç›®å·)===String(projectId));
  if(!list.length){ 
    section.classList.remove("hidden"); 
    tbody.innerHTML="<tr><td colspan='5' class='p-2 border-b text-gray-500'>æœªæ‰¾åˆ°BOM</td></tr>"; 
    return;
  }

  tbody.innerHTML=list.map(row=>{
    const cz=czData.find(c=>String(c.ç‰©æ–™é¡¹ç›®å·)===String(row.ç‰©æ–™é¡¹ç›®å·));
    return `
      <tr class="hover:bg-gray-50 transition">
        <td class="p-2 border-b">${row.ç‰©æ–™é¡¹ç›®å·}</td>
        <td class="p-2 border-b">${row.ç‰©æ–™åç§°}</td>
        <td class="p-2 border-b">${row.æ•°é‡}</td>
        <td class="p-2 border-b">${row.è®¡é‡å•ä½}</td>
        <td class="p-2 border-b">${cz ? cz.é‡‡è´­å•ä»· : "â€”"}</td>
      </tr>`;
  }).join("");
  section.classList.remove("hidden");
}

// æ’åºåŠŸèƒ½ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œä½†ç§»é™¤æ ·å¼ç±»ï¼Œå› æ–°è¡¨æ ¼æ— æ’åºç®­å¤´éœ€æ±‚ï¼‰
// è‹¥ä»éœ€æ’åºï¼Œè¯·å‘ŠçŸ¥ï¼Œæ­¤å¤„æš‚æŒ‰â€œä¸æ˜¾ç¤ºæ’åºç®­å¤´â€å¤„ç†ä»¥åŒ¹é…ç‰©æ–™é¡µé£æ ¼
document.querySelectorAll("#resultTable thead th").forEach((th, index) => {
  if (index === 0 || index === 8) return; // è·³è¿‡ åºå· å’Œ æ“ä½œ åˆ—
  th.style.cursor = "pointer";
  th.addEventListener("click", () => {
    const keyMap = ["", "é¡¹ç›®å·", "å“å", "è§„æ ¼", "å•ä½", "é›¶å”®ä»·", "å“ç‰Œ", "å¯ä¾›åº”æ¸ é“"];
    const key = keyMap[index];
    if (!key) return;
    sortDirection[key] = !sortDirection[key];
    const dir = sortDirection[key] ? 1 : -1;
    currentData.sort((a,b) => {
      const x = a[key], y = b[key];
      if (!isNaN(x) && !isNaN(y)) return (x - y) * dir;
      return String(x ?? "").localeCompare(String(y ?? "")) * dir;
    });
    renderTable();
  });
});

// å¯¼å‡ºExcel
document.getElementById("exportBtn").onclick=()=>{
  if(!currentData.length)return alert("æš‚æ— æ•°æ®");
  const data=currentData.map((i,idx)=>({
    åºå·:idx+1,é¡¹ç›®å·:i.é¡¹ç›®å·,å“å:i.å“å,è§„æ ¼:i.è§„æ ¼,å•ä½:i.å•ä½,
    é›¶å”®ä»·:i.é›¶å”®ä»·,å“ç‰Œ:i.å“ç‰Œ,æ¸ é“:i.å¯ä¾›åº”æ¸ é“
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"æˆå“ä¿¡æ¯");
  XLSX.writeFile(wb,"æˆå“æŸ¥è¯¢.xlsx");
};

// é‡ç½®æŒ‰é’®
document.getElementById("resetBtn").onclick = resetForm;

// å›è½¦æŸ¥è¯¢
document.addEventListener("keydown",e=>{if(e.key==="Enter")search();});

// æŸ¥è¯¢æŒ‰é’®
document.getElementById("searchBtn").onclick = search;
</script>
</body>
</html>
