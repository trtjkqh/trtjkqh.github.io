<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>库存查询</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f9fafb; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #4f46e5; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-2xl font-bold mb-4 text-gray-800">库存查询系统</h1>

  <div class="flex flex-wrap gap-4 mb-6">
    <select id="warehouse" class="border rounded px-3 py-2">
      <option value="">全部仓库</option>
      <option value="包材库">包材库</option>
      <option value="1号库">1号库</option>
      <option value="2号库">2号库</option>
      <option value="5号库">5号库</option>
    </select>

    <input id="projectId" type="text" placeholder="按项目号查询（精准）" class="border rounded px-3 py-2">
    <input id="nameSearch" type="text" placeholder="按物料名称查询（模糊）" class="border rounded px-3 py-2">
    <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">查询</button>
    <button id="resetBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">重置</button>
  </div>

  <div class="overflow-x-auto">
    <table id="dataTable">
      <thead>
        <tr>
          <th>序号</th>
          <th>所在库</th>
          <th>物料项目号</th>
          <th>物料名称</th>
          <th>说明</th>
          <th>计量单位</th>
          <th>数量</th>
          <th>采购单价</th>
          <th>金额</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="9" class="py-4 text-gray-500">正在加载数据...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    let data = [];
    let tzData = {};

    async function loadData() {
      try {
        const [kcRes, tzRes] = await Promise.all([
          fetch('data.json'),
          fetch('../tz/data.json')
        ]);
        data = await kcRes.json();
        tzData = await tzRes.json();

        // 以物料项目号为键，建立单价映射
        const priceMap = {};
        tzData.forEach(item => {
          if (item["物料项目号"] && item["采购单价"])
            priceMap[item["物料项目号"]] = item["采购单价"];
        });

        // 自动补齐缺失单价和金额
        data.forEach(item => {
          if (!item["采购单价"] && priceMap[item["物料项目号"]]) {
            item["采购单价"] = priceMap[item["物料项目号"]];
          }
          if (!item["金额"] && item["采购单价"] && item["数量"]) {
            item["金额"] = (item["采购单价"] * item["数量"]).toFixed(2);
          }
        });

        renderTable(data);
      } catch (err) {
        document.getElementById("tableBody").innerHTML = 
          `<tr><td colspan="9" class="text-red-600">数据加载失败，请检查data.json和tz/data.json路径。</td></tr>`;
      }
    }

    function renderTable(list) {
      const tbody = document.getElementById("tableBody");
      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="py-4 text-gray-500">没有匹配的记录</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(item => `
        <tr>
          <td>${item["序号"] || ""}</td>
          <td>${item["所在库"] || ""}</td>
          <td>${item["物料项目号"] || ""}</td>
          <td>${item["物料名称"] || ""}</td>
          <td>${item["说明"] || ""}</td>
          <td>${item["计量单位"] || ""}</td>
          <td>${item["数量"] || ""}</td>
          <td>${item["采购单价"] || ""}</td>
          <td>${item["金额"] || ""}</td>
        </tr>
      `).join("");
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
      const warehouse = document.getElementById("warehouse").value.trim();
      const projectId = document.getElementById("projectId").value.trim();
      const name = document.getElementById("nameSearch").value.trim();

      const filtered = data.filter(item => {
        const matchWarehouse = !warehouse || item["所在库"] === warehouse;
        const matchProject = !projectId || item["物料项目号"].toString() === projectId;
        const matchName = !name || item["物料名称"].includes(name);
        return matchWarehouse && matchProject && matchName;
      });

      renderTable(filtered);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("warehouse").value = "";
      document.getElementById("projectId").value = "";
      document.getElementById("nameSearch").value = "";
      renderTable(data);
    });

    loadData();
  </script>
</body>
</html>
