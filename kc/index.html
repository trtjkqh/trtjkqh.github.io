<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>库存查询</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen py-10">
  <div class="max-w-[1000px] mx-auto bg-white p-6 rounded-xl shadow-lg">

    <!-- 查询区域 -->
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <span class="text-gray-500 text-sm">数据基于2025年10月</span>

      <select id="warehouse" class="border rounded px-3 py-2">
        <option value="">选择仓库</option>
        <option>包材库</option>
        <option>1号库</option>
        <option>2号库</option>
        <option>5号库</option>
        <option>包材库-D</option>
      </select>

      <input id="itemId" type="number" placeholder="物料项目号（精准）" class="border rounded px-3 py-2 w-48" />
      <input id="itemName" type="text" placeholder="物料名称（模糊）" class="border rounded px-3 py-2 w-60" />

      <button id="searchBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">查询</button>
      <button id="resetBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">重置</button>
    </div>

    <!-- 结果表格 -->
    <div id="resultArea" class="hidden mt-6 overflow-x-auto">
      <table class="w-full border-collapse text-sm text-gray-700">
        <thead class="bg-gray-200 text-gray-800">
          <tr>
            <th class="border p-2">序号</th>
            <th class="border p-2">所在库</th>
            <th class="border p-2">物料项目号</th>
            <th class="border p-2">物料名称</th>
            <th class="border p-2">说明</th>
            <th class="border p-2">计量单位</th>
            <th class="border p-2">数量</th>
            <th class="border p-2">采购单价</th>
            <th class="border p-2">金额</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div id="stats" class="text-right text-gray-600 text-sm mt-3"></div>
    </div>
  </div>

  <script>
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const tableBody = document.getElementById('tableBody');
    const resultArea = document.getElementById('resultArea');
    const stats = document.getElementById('stats');

    let data = [];
    let tzData = [];

    async function loadData() {
      const res = await fetch('data.json');
      data = await res.json();

      try {
        const tzRes = await fetch('../tz/data.json');
        tzData = await tzRes.json();
      } catch {
        tzData = [];
      }
    }

    function renderTable(filtered) {
      if (filtered.length === 0) {
        resultArea.classList.add('hidden');
        return;
      }

      tableBody.innerHTML = '';
      let totalAmount = 0;

      filtered.forEach((item, index) => {
        let price = item['采购单价'];
        let amount = item['金额'];

        // 若单价为空，从 tz/data.json 匹配
        if ((!price || !amount) && tzData.length > 0) {
          const match = tzData.find(t => t['物料项目号'] == item['物料项目号']);
          if (match) {
            price = match['采购单价'] || price;
            amount = item['数量'] * price;
          }
        }

        totalAmount += Number(amount) || 0;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border p-2 text-center">${index + 1}</td>
          <td class="border p-2 text-center">${item['所在库']}</td>
          <td class="border p-2 text-center">${item['物料项目号']}</td>
          <td class="border p-2">${item['物料名称']}</td>
          <td class="border p-2">${item['说明'] || ''}</td>
          <td class="border p-2 text-center">${item['计量单位']}</td>
          <td class="border p-2 text-center bg-yellow-100 font-semibold">${item['数量']}</td>
          <td class="border p-2 text-center">${price ?? ''}</td>
          <td class="border p-2 text-center">${amount ?? ''}</td>
        `;
        tableBody.appendChild(tr);
      });

      resultArea.classList.remove('hidden');
      stats.textContent = `共查询到 ${filtered.length} 条记录，合计金额：${totalAmount.toFixed(2)} 元`;
    }

    searchBtn.addEventListener('click', () => {
      const warehouse = document.getElementById('warehouse').value.trim();
      const itemId = document.getElementById('itemId').value.trim();
      const itemName = document.getElementById('itemName').value.trim();

      const filtered = data.filter(item => (
        (!warehouse || item['所在库'] === warehouse) &&
        (!itemId || String(item['物料项目号']) === itemId) &&
        (!itemName || item['物料名称'].includes(itemName))
      ));

      renderTable(filtered);
    });

    resetBtn.addEventListener('click', () => {
      document.getElementById('warehouse').value = '';
      document.getElementById('itemId').value = '';
      document.getElementById('itemName').value = '';
      resultArea.classList.add('hidden');
    });

    loadData();
  </script>
</body>
</html>
