<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯æ—¥å¾…åŠ - å¯è‡ªå®šä¹‰åˆ—å®½</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<style>
body { background:#fff7ed; color:#431407; transition:all 0.3s; }
header, section { margin:10px auto; max-width:1200px; }
.save-indicator { position:fixed; bottom:20px; right:20px; background:#10b981; color:white; padding:8px 16px; border-radius:4px; font-size:0.875rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); opacity:0; transition:opacity 0.3s; z-index:1000; }
.save-indicator.show { opacity:1; }
.fade-in { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

/* å¯æ‹–æ‹½åˆ—å®½ */
th.resizable { position: relative; }
th.resizable div { overflow: hidden; }
th.resizable span { position: absolute; right: 0; top: 0; bottom: 0; width: 5px; cursor: col-resize; user-select: none; }

/* æŒ‰é’®ç»„è‡ªé€‚åº”æ˜¾ç¤º */
.button-group { display:flex; flex-wrap:wrap; gap:5px; }
.button-group button { white-space:nowrap; cursor:pointer; }
</style>
</head>
<body>

<header class="bg-white rounded-xl shadow-md p-4 flex justify-between items-center relative">
  <div class="button-group">
    <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="manualSave()">ğŸ’¾ ä¿å­˜æ•°æ®</button>
    <button class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600" onclick="addRow()">æ–°å¢äº‹é¡¹</button>
    <button class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
    <button class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
  </div>
  <div>ğŸ“… <script>document.write(new Date().toLocaleDateString());</script></div>
</header>

<section id="unified-section" class="bg-white rounded-xl shadow-md p-4 fade-in"></section>

<div id="saveIndicator" class="save-indicator">æ•°æ®å·²ä¿å­˜</div>

<script>
const types=['åˆåŒ','åœ¨é€”','æ‰“æ ·'];
const columns=['ç±»å‹','ä¼˜å…ˆçº§','ç‰©æ–™å','ä¾›åº”å•†å','è¿›å±•','å¤‡æ³¨','å¼€å§‹æ—¥','ç»“æŸæ—¥'];
let unifiedData=JSON.parse(localStorage.getItem('unifiedData')||'[]');
let colWidths=JSON.parse(localStorage.getItem('colWidths')||'{}');

// è‡ªåŠ¨ä¿å­˜
function autoSave(){ localStorage.setItem('unifiedData',JSON.stringify(unifiedData)); showSaveIndicator(); }
function manualSave(){ localStorage.setItem('unifiedData',JSON.stringify(unifiedData)); showSaveIndicator(); }

function showSaveIndicator(){ const ind=document.getElementById('saveIndicator'); ind.classList.add('show'); setTimeout(()=>ind.classList.remove('show'),1500); }

// æ–°å¢/åˆ é™¤è¡Œ
function addRow(){ const newRow={}; columns.forEach(col=>{ if(col==='ç±»å‹') newRow[col]='åˆåŒ'; else if(col==='ä¼˜å…ˆçº§') newRow[col]='ä¸­'; else newRow[col]=''; }); unifiedData.push(newRow); renderTable(); autoSave(); }
function deleteRow(i){ unifiedData.splice(i,1); renderTable(); autoSave(); }

// Excel å¯¼å‡º
function exportToExcel(){ let csv="data:text/csv;charset=utf-8,\uFEFF"; csv+=columns.join(',')+'\n'; unifiedData.forEach(r=>{ csv+=columns.map(c=>`"${r[c]||''}"`).join(',')+'\n'; }); const link=document.createElement("a"); link.setAttribute("href",encodeURI(csv)); link.setAttribute("download",`æ¯æ—¥å¾…åŠ_${new Date().toLocaleDateString()}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

// æ¸…ç©ºæ•°æ®
function clearAllData(){ if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')){ unifiedData=[]; renderTable(); autoSave(); } }

// æ¸²æŸ“è¡¨æ ¼
function renderTable(){
  const container=document.getElementById('unified-section');
  container.innerHTML=`<div class="overflow-x-auto"><table class="min-w-full border text-sm" id="unified-table"><thead><tr><th class="border px-2 py-1" style="width:40px;">åºå·</th>${columns.map(c=>`<th class="border px-2 py-1 resizable" style="width:${colWidths[c]||150}px"><div>${c}</div><span></span></th>`).join('')}<th class="border px-2 py-1">æ“ä½œ</th></tr></thead><tbody id="unified-table-body"></tbody></table></div>`;
  const tbody=document.getElementById('unified-table-body');
  unifiedData.forEach((row,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="border px-2 py-1 text-center">${i+1}</td>`+columns.map(col=>{
      if(col==='ç±»å‹') return `<td class="border px-2 py-1"><select onchange="rowTypeChange(${i},this.value)">${types.map(t=>`<option value="${t}" ${row[col]===t?'selected':''}>${t}</option>`)}</select></td>`;
      if(col==='ä¼˜å…ˆçº§') return `<td class="border px-2 py-1"><select onchange="rowPriorityChange(${i},this.value)"><option value="é«˜" ${row[col]==='é«˜'?'selected':''}>é«˜</option><option value="ä¸­" ${row[col]==='ä¸­'?'selected':''}>ä¸­</option><option value="ä½" ${row[col]==='ä½'?'selected':''}>ä½</option></select></td>`;
      return `<td class="border px-2 py-1" contenteditable="true" oninput="rowEdit(${i},'${col}',this.innerText)">${row[col]||''}</td>`;
    }).join('')+`<td class="border px-2 py-1 text-center"><button onclick="deleteRow(${i})" class="bg-blue-500 text-white px-2 py-1 rounded">åˆ é™¤</button></td>`;
    tbody.appendChild(tr);
  });
  makeResizable();
  Sortable.create(tbody,{animation:150,onEnd:e=>{const newData=[]; Array.from(tbody.children).forEach(tr=>{ const idx=parseInt(tr.children[0].innerText)-1; newData.push(unifiedData[idx]); }); unifiedData=newData; renderTable(); autoSave(); }});
}

// è¡Œç¼–è¾‘
function rowEdit(i,col,val){ unifiedData[i][col]=val; autoSave(); }
function rowTypeChange(i,val){ unifiedData[i]['ç±»å‹']=val; autoSave(); }
function rowPriorityChange(i,val){ unifiedData[i]['ä¼˜å…ˆçº§']=val; autoSave(); }

// å¯æ‹–æ‹½åˆ—å®½ + è®°å¿†
function makeResizable(){
  const table=document.getElementById('unified-table');
  const cols=table.querySelectorAll('th.resizable');
  cols.forEach(th=>{
    const span=th.querySelector('span');
    const colName=th.innerText.trim();
    span.onmousedown=e=>{
      let startX=e.pageX,startWidth=th.offsetWidth;
      document.onmousemove=em=>{
        const newWidth=startWidth+(em.pageX-startX);
        if(newWidth>30) th.style.width=newWidth+'px';
      }
      document.onmouseup=()=>{
        document.onmousemove=null; document.onmouseup=null;
        colWidths[colName]=th.offsetWidth;
        localStorage.setItem('colWidths',JSON.stringify(colWidths));
      }
    }
  });
}

// åˆå§‹åŒ–
renderTable();
</script>

</body>
</html>
