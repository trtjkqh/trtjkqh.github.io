<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM查询</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* 动画统一为物料页风格 */
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
  .fade-in { animation: fadeIn 0.4s ease-in; }

  /* 高亮搜索词 */
  mark {
    background-color: #fff59d;
    padding: 0;
    color: inherit;
  }

  /* 父子行视觉区分（使用 Tailwind 兼容色） */
  .parent-row {
    background-color: #dbeafe !important; /* blue-100 */
    font-weight: 600;
  }
  .child-row {
    background-color: #f0f9ff !important; /* blue-50 */
  }
  .parent-row:hover,
  .child-row:hover {
    background-color: #bfdbfe !important; /* blue-200 */
  }
</style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

<!-- 主内容 -->
<div id="mainContent" class="transition-opacity duration-500">

  <!-- 查询区域 -->
  <div class="max-w-7xl mx-auto bg-white shadow rounded-xl p-6 mb-6 flex flex-wrap gap-3 items-center fade-in">
    <input id="nameSearch" type="text" placeholder="品名（模糊搜索）" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />
    <input id="projectSearch" type="text" placeholder="项目号（精准搜索）" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />
    <input id="materialIDSearch" type="text" placeholder="物料项目号（精准搜索）" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />
    <input id="materialNameSearch" type="text" placeholder="物料名称（模糊搜索）" class="border border-gray-300 rounded-lg p-2 flex-1 focus:ring-2 focus:ring-red-400" />

    <button id="searchBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition shadow">查询</button>
    <button id="resetBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition shadow">重置</button>
  </div>

  <!-- 加载提示 -->
  <div id="loading" class="max-w-7xl mx-auto text-center text-red-600 font-medium my-6 fade-in">⏳ 正在加载数据，请稍候...</div>

  <!-- 查询结果 -->
  <div id="result" class="max-w-7xl mx-auto overflow-x-auto fade-in"></div>

</div>

<script>
let bomData=[], priceData={};
let bomLoaded=false, priceLoaded=false;

// 加载BOM数据
fetch('bom_data.json?_v='+Date.now())
.then(res=>res.json())
.then(data=>{
  bomData=data.map(i=>({
    项目号:String(i.项目号||"").trim(),
    品名:String(i.品名||"").trim(),
    规格:String(i.规格||"").trim(),
    零售价:String(i["零售价（元）"]??i.零售价??"").trim(),
    物料项目号:String(i.物料项目号||"").trim(),
    物料名称:String(i.物料名称||"").trim(),
    数量:String(i.数量||"").trim(),
    计量单位:String(i.计量单位||"").trim()
  }));
  bomLoaded=true; checkAllLoaded();
}).catch(err=>{
  console.error(err);
  document.getElementById("loading").textContent="❌ BOM数据加载失败";
});

// 加载采购单价
fetch('../tz/data.json?_v='+Date.now())
.then(res=>res.json())
.then(data=>{
  data.forEach(i=>{
    const id=String(i.物料项目号||"").trim();
    const price=i.采购单价!==undefined ? i.采购单价 : "-";
    priceData[id]=price;
  });
  priceLoaded=true; checkAllLoaded();
}).catch(err=>{
  console.error(err);
  document.getElementById("loading").textContent="❌ 采购单价加载失败";
});

function checkAllLoaded(){
  if(bomLoaded && priceLoaded){
    document.getElementById("loading").style.display="none";
  }
}

// 高亮关键词
function highlight(text, keyword){
  if(!keyword) return text||"";
  const reg=new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,"gi");
  return (text||"").replace(reg,"<mark>$1</mark>");
}

// 渲染查询结果
function renderFiltered(){
  const nameKeyword=document.getElementById("nameSearch").value.trim();
  const projectID=document.getElementById("projectSearch").value.trim();
  const materialID=document.getElementById("materialIDSearch").value.trim();
  const materialName=document.getElementById("materialNameSearch").value.trim();
  const resultDiv=document.getElementById("result");
  resultDiv.innerHTML="";

  if(!nameKeyword && !projectID && !materialID && !materialName){
    alert("请输入至少一项查询条件！");
    return;
  }

  let filtered=bomData.filter(i=>
    (!nameKeyword||i.品名.includes(nameKeyword)) &&
    (!projectID||i.项目号===projectID)
  );

  if(materialID||materialName){
    const matchedProjects=new Set(
      bomData.filter(i=>
        (!materialID||i.物料项目号===materialID) &&
        (!materialName||i.物料名称.includes(materialName))
      ).map(i=>i.项目号)
    );
    filtered=filtered.filter(i=>matchedProjects.has(i.项目号));
  }

  if(filtered.length===0){
    resultDiv.innerHTML="<p class='text-center text-gray-500'>未找到匹配结果。</p>";
    return;
  }

  const grouped={};
  filtered.forEach(i=>{ if(!grouped[i.项目号]) grouped[i.项目号]=[]; grouped[i.项目号].push(i); });

  let tableHTML = `
    <table class="w-full text-sm text-center border border-gray-200 rounded-lg shadow-sm">
      <thead class="bg-gray-100 font-semibold sticky top-0">
        <tr>
          <th class="p-2 border-b">项目号</th>
          <th class="p-2 border-b">品名</th>
          <th class="p-2 border-b">规格</th>
          <th class="p-2 border-b">零售价</th>
          <th class="p-2 border-b">物料项目号</th>
          <th class="p-2 border-b">物料名称</th>
          <th class="p-2 border-b">数量</th>
          <th class="p-2 border-b">计量单位</th>
          <th class="p-2 border-b">采购单价</th>
        </tr>
      </thead>
      <tbody>
  `;

  for(const [proj, items] of Object.entries(grouped)){
    const parent = items[0];
    tableHTML += `
      <tr class="parent-row">
        <td class="p-2 border-b">${highlight(parent.项目号, projectID)}</td>
        <td class="p-2 border-b">${highlight(parent.品名, nameKeyword)}</td>
        <td class="p-2 border-b">${highlight(parent.规格, "")}</td>
        <td class="p-2 border-b">${highlight(parent.零售价, "")}</td>
        <td colspan="5" class="p-2 border-b"></td>
      </tr>
    `;

    items.forEach(child => {
      const id = child.物料项目号;
      const purchasePrice = priceData[id] !== undefined ? priceData[id] : "—";
      tableHTML += `
        <tr class="child-row hover:bg-red-50 transition">
          <td colspan="4" class="p-2 border-b"></td>
          <td class="p-2 border-b">${highlight(child.物料项目号, materialID)}</td>
          <td class="p-2 border-b">${highlight(child.物料名称, materialName)}</td>
          <td class="p-2 border-b">${highlight(child.数量, "")}</td>
          <td class="p-2 border-b">${highlight(child.计量单位, "")}</td>
          <td class="p-2 border-b">${purchasePrice}</td>
        </tr>
      `;
    });
  }

  tableHTML += `
      </tbody>
    </table>
  `;

  resultDiv.innerHTML = tableHTML;
}

// 绑定事件
document.getElementById("searchBtn").addEventListener("click", renderFiltered);
document.getElementById("resetBtn").addEventListener("click",()=>{
  ["nameSearch","projectSearch","materialIDSearch","materialNameSearch"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("result").innerHTML="";
});
document.querySelectorAll("#nameSearch,#projectSearch,#materialIDSearch,#materialNameSearch").forEach(input=>{
  input.addEventListener("keypress",e=>{ if(e.key==="Enter") renderFiltered(); });
});
</script>
</body>
</html>
