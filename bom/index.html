<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>产品 BOM 查询</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeIn 0.4s ease-in; }
</style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<!-- 标题栏 -->
<div class="max-w-6xl mx-auto bg-white rounded-xl shadow-md p-4 mt-6 mb-4 fade-in">
  <div class="flex items-center justify-center gap-3">
    <img src="../assets/img/trtlogo.png" alt="LOGO" class="h-10 w-auto object-contain">
    <h1 class="text-xl md:text-2xl font-semibold text-gray-800 text-center">产品 BOM 查询系统</h1>
  </div>
</div>

<!-- 查询区 -->
<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">
  <h2 class="text-lg font-semibold mb-4 text-gray-700">查询条件</h2>
  <div class="flex flex-wrap gap-4 items-center">
    <input id="projectInput" type="text" placeholder="项目号（精准匹配）" class="border rounded-lg p-2 flex-1 min-w-[180px] focus:ring focus:ring-blue-200">
    <input id="nameInput" type="text" placeholder="产品名称（模糊匹配）" class="border rounded-lg p-2 flex-1 min-w-[180px] focus:ring focus:ring-blue-200">
    <button onclick="searchBOM()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition shadow">查询</button>
    <button onclick="resetSearch()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">重置</button>
  </div>
</div>

<!-- 查询结果 -->
<div id="resultContainer" class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 fade-in hidden">

  <!-- 表头直接显示在顶部 -->
  <div class="grid grid-cols-7 gap-2 bg-red-100 text-red-700 font-semibold text-sm py-2 px-3 rounded-md mb-2">
    <div>物料编码</div>
    <div>物料名称</div>
    <div>规格型号</div>
    <div>数量</div>
    <div>单位</div>
    <div>单价(元)</div>
  </div>

  <!-- 数据区域 -->
  <div id="bomDetails" class="divide-y divide-gray-200"></div>

  <!-- 导出按钮 -->
  <div class="mt-4 text-right">
    <button id="exportBtn" onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
      导出为 Excel
    </button>
  </div>
</div>

<!-- 保密提示 -->
<p class="text-center text-gray-500 text-sm mt-8 mb-6">※ 本页面数据仅限内部使用，严禁外传</p>

<script>
let bomData = [];
let priceData = [];

// 读取 JSON 数据
async function loadData() {
  const [bomRes, priceRes] = await Promise.all([
    fetch("data.json"),
    fetch("../tz/data.json")
  ]);
  bomData = await bomRes.json();
  priceData = await priceRes.json();
}

async function searchBOM() {
  const project = document.getElementById("projectInput").value.trim();
  const name = document.getElementById("nameInput").value.trim();
  if (!project && !name) {
    alert("请输入项目号或产品名称！");
    return;
  }

  await loadData();

  const matched = bomData.filter(item =>
    (project && item.项目号 === project) ||
    (name && item.品名 && item.品名.includes(name))
  );

  const container = document.getElementById("bomDetails");
  container.innerHTML = "";
  document.getElementById("resultContainer").classList.remove("hidden");

  if (matched.length === 0) {
    container.innerHTML = `<p class='text-gray-500 text-sm mt-4'>未找到匹配的产品。</p>`;
    return;
  }

  const bomList = matched[0].BOM || [];
  bomList.forEach(row => {
    const priceInfo = priceData.find(p => p.物料名称 === row.物料名称);
    const price = priceInfo ? parseFloat(priceInfo.采购单价) : 0;
    const subtotal = (price * parseFloat(row.数量 || 0)).toFixed(2);
    
    container.innerHTML += `
      <div class="grid grid-cols-7 gap-2 py-2 px-3 hover:bg-gray-50 text-sm">
        <div>${row.物料编码 || ""}</div>
        <div>${row.物料名称 || ""}</div>
        <div>${row.规格型号 || ""}</div>
        <div>${row.数量 || ""}</div>
        <div>${row.单位 || ""}</div>
        <div>${price ? price.toFixed(2) : "-"}</div>
        <div>${subtotal}</div>
      </div>
    `;
  });
}

function resetSearch() {
  document.getElementById("projectInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("resultContainer").classList.add("hidden");
}

function exportExcel() {
  const rows = [["物料编码", "物料名称", "规格型号", "数量", "单位", "单价(元)"]];
  document.querySelectorAll("#bomDetails > div").forEach(div => {
    const cols = [...div.children].map(td => td.textContent.trim());
    rows.push(cols);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "BOM明细");
  XLSX.writeFile(wb, "BOM明细.xlsx");
}
</script>

</body>
</html>
