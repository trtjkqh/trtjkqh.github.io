<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¾›åº”å•†ä¿¡æ¯ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-lg">
    <h1 class="text-2xl font-bold mb-4 text-blue-700">ä¾›åº”å•†ä¿¡æ¯ç®¡ç†</h1>

    <div id="loading" class="text-gray-500 mb-4">â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <div id="statistics" class="mb-4 text-sm text-gray-600"></div>

    <!-- è¡¨æ ¼ -->
    <div class="overflow-x-auto">
      <table id="supplierTable" class="min-w-full border border-gray-300 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">ç¼–å·</th>
            <th class="p-2 border">åç§°</th>
            <th class="p-2 border">è”ç³»äºº</th>
            <th class="p-2 border">ç”µè¯</th>
            <th class="p-2 border">ä¾›åº”å“ç±»</th>
            <th class="p-2 border">åˆä½œçŠ¶æ€</th>
            <th class="p-2 border">èµ·å§‹æ—¥æœŸ</th>
            <th class="p-2 border">ä¿¡ç”¨ç­‰çº§</th>
            <th class="p-2 border">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="supplierTableBody"></tbody>
      </table>
    </div>

    <!-- ç¼–è¾‘çª—å£ -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-lg font-bold mb-3 text-blue-600">ç¼–è¾‘ä¾›åº”å•†ä¿¡æ¯</h2>
        <form id="editForm" class="space-y-2">
          <input type="hidden" id="editId">
          <div>
            <label class="block text-sm">åç§°</label>
            <input id="editName" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">è”ç³»äºº</label>
            <input id="editContactPerson" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">ç”µè¯</label>
            <input id="editPhone" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">ä¾›åº”å“ç±»</label>
            <input id="editCategory" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">åˆä½œçŠ¶æ€</label>
            <select id="editStatus" class="w-full border p-2 rounded">
              <option value="active">åˆä½œä¸­</option>
              <option value="pending">å¾…å®¡æ ¸</option>
              <option value="inactive">æš‚åœåˆä½œ</option>
              <option value="terminated">å·²ç»ˆæ­¢</option>
            </select>
          </div>
          <div class="flex justify-end mt-4 space-x-2">
            <button type="button" id="cancelEdit" class="px-3 py-1 bg-gray-300 rounded">å–æ¶ˆ</button>
            <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script>
    let suppliers = JSON.parse(localStorage.getItem("suppliers") || "[]");

    // åŠ è½½ JSON æ•°æ®å¹¶è½¬æ¢å­—æ®µ
    async function loadSuppliersFromJSON() {
      try {
        const response = await fetch("data.json");
        const raw = await response.json();

        suppliers = raw.map(item => ({
          id: item["ä¾›åº”å•†ç¼–å·"],
          name: item["åç§°"],
          contactPerson: item["è”ç³»äºº"],
          phone: item["è”ç³»ç”µè¯"],
          category: item["ä¾›åº”å“ç±»"],
          startDate: excelDateToISO(item["åˆä½œèµ·å§‹æ—¥æœŸ"]),
          status: mapStatus(item["åˆä½œçŠ¶æ€"]),
          credit: item["ä¿¡ç”¨ç­‰çº§"]
        }));

        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        renderSupplierTable();
        updateStatistics();
        document.getElementById("loading").style.display = "none";
      } catch (e) {
        document.getElementById("loading").textContent = "âš ï¸ åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®";
        renderSupplierTable();
      }
    }

    function excelDateToISO(serial) {
      if (!serial || isNaN(serial)) return "";
      const utc_days = Math.floor(serial - 25569);
      const utc_value = utc_days * 86400;
      const date_info = new Date(utc_value * 1000);
      return date_info.toISOString().split("T")[0];
    }

    function mapStatus(status) {
      switch (status) {
        case "åˆä½œä¸­": return "active";
        case "å¾…å®¡æ ¸": return "pending";
        case "æš‚åœåˆä½œ": return "inactive";
        case "å·²ç»ˆæ­¢": return "terminated";
        default: return "";
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderSupplierTable() {
      const tbody = document.getElementById("supplierTableBody");
      tbody.innerHTML = "";
      suppliers.forEach((s, index) => {
        const tr = document.createElement("tr");
        tr.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";
        tr.innerHTML = `
          <td class="border p-2">${s.id}</td>
          <td class="border p-2">${s.name}</td>
          <td class="border p-2">${s.contactPerson}</td>
          <td class="border p-2">${s.phone}</td>
          <td class="border p-2">${s.category}</td>
          <td class="border p-2">${formatStatus(s.status)}</td>
          <td class="border p-2">${s.startDate}</td>
          <td class="border p-2">${s.credit}</td>
          <td class="border p-2 text-center">
            <button class="text-blue-600 hover:underline" onclick="editSupplier('${s.id}')">ç¼–è¾‘</button>
            <button class="text-red-600 hover:underline ml-2" onclick="deleteSupplier('${s.id}')">åˆ é™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatStatus(status) {
      const map = {
        active: "âœ… åˆä½œä¸­",
        pending: "ğŸ•“ å¾…å®¡æ ¸",
        inactive: "â¸ï¸ æš‚åœ",
        terminated: "âŒ ç»ˆæ­¢"
      };
      return map[status] || status;
    }

    // ç¼–è¾‘åŠŸèƒ½
    function editSupplier(id) {
      const supplier = suppliers.find(s => s.id == id);
      if (!supplier) return;
      document.getElementById("editModal").classList.remove("hidden");
      document.getElementById("editId").value = supplier.id;
      document.getElementById("editName").value = supplier.name;
      document.getElementById("editContactPerson").value = supplier.contactPerson;
      document.getElementById("editPhone").value = supplier.phone;
      document.getElementById("editCategory").value = supplier.category;
      document.getElementById("editStatus").value = supplier.status;
    }

    document.getElementById("cancelEdit").onclick = () => {
      document.getElementById("editModal").classList.add("hidden");
    };

    document.getElementById("editForm").onsubmit = (e) => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const index = suppliers.findIndex(s => s.id == id);
      if (index !== -1) {
        suppliers[index].name = document.getElementById("editName").value;
        suppliers[index].contactPerson = document.getElementById("editContactPerson").value;
        suppliers[index].phone = document.getElementById("editPhone").value;
        suppliers[index].category = document.getElementById("editCategory").value;
        suppliers[index].status = document.getElementById("editStatus").value;
        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        renderSupplierTable();
      }
      document.getElementById("editModal").classList.add("hidden");
    };

    // åˆ é™¤åŠŸèƒ½
    function deleteSupplier(id) {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥ä¾›åº”å•†å—ï¼Ÿ")) return;
      suppliers = suppliers.filter(s => s.id != id);
      localStorage.setItem("suppliers", JSON.stringify(suppliers));
      renderSupplierTable();
    }

    // ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
      const total = suppliers.length;
      const active = suppliers.filter(s => s.status === "active").length;
      const inactive = suppliers.filter(s => s.status === "inactive").length;
      document.getElementById("statistics").textContent =
        `å…±æœ‰ä¾›åº”å•† ${total} å®¶ï¼Œå…¶ä¸­åˆä½œä¸­ ${active} å®¶ï¼Œæš‚åœåˆä½œ ${inactive} å®¶`;
    }

    loadSuppliersFromJSON();
  </script>
</body>
</html>
