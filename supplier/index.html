<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>供应商信息管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-lg">
    <h1 class="text-2xl font-bold mb-4 text-blue-700">供应商信息管理</h1>

    <div id="loading" class="text-gray-500 mb-4">⏳ 正在加载数据...</div>
    <div id="statistics" class="mb-4 text-sm text-gray-600"></div>

    <!-- 表格 -->
    <div class="overflow-x-auto">
      <table id="supplierTable" class="min-w-full border border-gray-300 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">编号</th>
            <th class="p-2 border">名称</th>
            <th class="p-2 border">联系人</th>
            <th class="p-2 border">电话</th>
            <th class="p-2 border">供应品类</th>
            <th class="p-2 border">合作状态</th>
            <th class="p-2 border">起始日期</th>
            <th class="p-2 border">信用等级</th>
            <th class="p-2 border">操作</th>
          </tr>
        </thead>
        <tbody id="supplierTableBody"></tbody>
      </table>
    </div>

    <!-- 编辑窗口 -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-lg font-bold mb-3 text-blue-600">编辑供应商信息</h2>
        <form id="editForm" class="space-y-2">
          <input type="hidden" id="editId">
          <div>
            <label class="block text-sm">名称</label>
            <input id="editName" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">联系人</label>
            <input id="editContactPerson" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">电话</label>
            <input id="editPhone" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">供应品类</label>
            <input id="editCategory" type="text" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm">合作状态</label>
            <select id="editStatus" class="w-full border p-2 rounded">
              <option value="active">合作中</option>
              <option value="pending">待审核</option>
              <option value="inactive">暂停合作</option>
              <option value="terminated">已终止</option>
            </select>
          </div>
          <div class="flex justify-end mt-4 space-x-2">
            <button type="button" id="cancelEdit" class="px-3 py-1 bg-gray-300 rounded">取消</button>
            <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">保存</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script>
    let suppliers = JSON.parse(localStorage.getItem("suppliers") || "[]");

    // 加载 JSON 数据并转换字段
    async function loadSuppliersFromJSON() {
      try {
        const response = await fetch("data.json");
        const raw = await response.json();

        suppliers = raw.map(item => ({
          id: item["供应商编号"],
          name: item["名称"],
          contactPerson: item["联系人"],
          phone: item["联系电话"],
          category: item["供应品类"],
          startDate: excelDateToISO(item["合作起始日期"]),
          status: mapStatus(item["合作状态"]),
          credit: item["信用等级"]
        }));

        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        renderSupplierTable();
        updateStatistics();
        document.getElementById("loading").style.display = "none";
      } catch (e) {
        document.getElementById("loading").textContent = "⚠️ 加载本地存储数据";
        renderSupplierTable();
      }
    }

    function excelDateToISO(serial) {
      if (!serial || isNaN(serial)) return "";
      const utc_days = Math.floor(serial - 25569);
      const utc_value = utc_days * 86400;
      const date_info = new Date(utc_value * 1000);
      return date_info.toISOString().split("T")[0];
    }

    function mapStatus(status) {
      switch (status) {
        case "合作中": return "active";
        case "待审核": return "pending";
        case "暂停合作": return "inactive";
        case "已终止": return "terminated";
        default: return "";
      }
    }

    // 渲染表格
    function renderSupplierTable() {
      const tbody = document.getElementById("supplierTableBody");
      tbody.innerHTML = "";
      suppliers.forEach((s, index) => {
        const tr = document.createElement("tr");
        tr.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";
        tr.innerHTML = `
          <td class="border p-2">${s.id}</td>
          <td class="border p-2">${s.name}</td>
          <td class="border p-2">${s.contactPerson}</td>
          <td class="border p-2">${s.phone}</td>
          <td class="border p-2">${s.category}</td>
          <td class="border p-2">${formatStatus(s.status)}</td>
          <td class="border p-2">${s.startDate}</td>
          <td class="border p-2">${s.credit}</td>
          <td class="border p-2 text-center">
            <button class="text-blue-600 hover:underline" onclick="editSupplier('${s.id}')">编辑</button>
            <button class="text-red-600 hover:underline ml-2" onclick="deleteSupplier('${s.id}')">删除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatStatus(status) {
      const map = {
        active: "✅ 合作中",
        pending: "🕓 待审核",
        inactive: "⏸️ 暂停",
        terminated: "❌ 终止"
      };
      return map[status] || status;
    }

    // 编辑功能
    function editSupplier(id) {
      const supplier = suppliers.find(s => s.id == id);
      if (!supplier) return;
      document.getElementById("editModal").classList.remove("hidden");
      document.getElementById("editId").value = supplier.id;
      document.getElementById("editName").value = supplier.name;
      document.getElementById("editContactPerson").value = supplier.contactPerson;
      document.getElementById("editPhone").value = supplier.phone;
      document.getElementById("editCategory").value = supplier.category;
      document.getElementById("editStatus").value = supplier.status;
    }

    document.getElementById("cancelEdit").onclick = () => {
      document.getElementById("editModal").classList.add("hidden");
    };

    document.getElementById("editForm").onsubmit = (e) => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const index = suppliers.findIndex(s => s.id == id);
      if (index !== -1) {
        suppliers[index].name = document.getElementById("editName").value;
        suppliers[index].contactPerson = document.getElementById("editContactPerson").value;
        suppliers[index].phone = document.getElementById("editPhone").value;
        suppliers[index].category = document.getElementById("editCategory").value;
        suppliers[index].status = document.getElementById("editStatus").value;
        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        renderSupplierTable();
      }
      document.getElementById("editModal").classList.add("hidden");
    };

    // 删除功能
    function deleteSupplier(id) {
      if (!confirm("确定要删除该供应商吗？")) return;
      suppliers = suppliers.filter(s => s.id != id);
      localStorage.setItem("suppliers", JSON.stringify(suppliers));
      renderSupplierTable();
    }

    // 统计信息
    function updateStatistics() {
      const total = suppliers.length;
      const active = suppliers.filter(s => s.status === "active").length;
      const inactive = suppliers.filter(s => s.status === "inactive").length;
      document.getElementById("statistics").textContent =
        `共有供应商 ${total} 家，其中合作中 ${active} 家，暂停合作 ${inactive} 家`;
    }

    loadSuppliersFromJSON();
  </script>
</body>
</html>
