<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>成本核算</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input-row { @apply flex flex-wrap gap-4 mb-5; }
    .input-col { @apply flex-1 min-w-[140px]; }
    .label { @apply block text-sm font-medium text-gray-700 mb-1; }
    .result-box { @apply mt-6 p-4 bg-red-50 border border-red-200 rounded-lg; }
    .result-row { @apply flex justify-between py-1.5; }
    .result-label { @apply font-semibold text-gray-700; }
    .result-value { @apply font-bold text-red-700; }
    .error { @apply text-red-600 font-bold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

<div class="max-w-7xl mx-auto bg-white shadow rounded-xl p-6 my-6">
  <h1 class="text-2xl font-bold text-red-600 mb-6">成本核算系统</h1>

  <!-- 第一行 -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">制费系数 (%)</label>
      <input type="number" step="0.01" id="overheadRate" value="12"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" />
    </div>
    <div class="input-col">
      <label class="label">原料（含税）</label>
      <input type="number" step="0.01" id="rawMaterial"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" placeholder="0.00" />
    </div>
    <div class="input-col">
      <label class="label">包材（含税）</label>
      <input type="number" step="0.01" id="packaging"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" placeholder="0.00" />
    </div>
    <div class="input-col">
      <label class="label">其他运费</label>
      <input type="number" step="0.01" id="otherFreight"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" placeholder="0.00" />
    </div>
  </div>

  <!-- 第二行：制造费用合计（只读） -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">制造费用合计<br><span class="text-xs text-gray-500">(人工+折旧+制费)</span></label>
      <input type="text" id="manufacturingCost" readonly
        class="w-full bg-gray-100 border border-gray-300 rounded-lg p-2 cursor-not-allowed" />
    </div>
  </div>

  <!-- 第三行 -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">市场定价毛利率 (%)</label>
      <input type="number" step="0.01" id="profitMargin" value="15"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" />
    </div>
    <div class="input-col">
      <label class="label">折扣 (%)</label>
      <input type="number" step="0.01" id="discount" value="45"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-400" />
    </div>
  </div>

  <!-- 结果区 -->
  <div class="result-box">
    <div id="errorMessage" class="error hidden mb-2"></div>
    
    <div class="result-row">
      <span class="result-label">合计成本（不含税）：</span>
      <span class="result-value" id="totalCost">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">出厂价：</span>
      <span class="result-value" id="factoryPrice">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">市场零售价：</span>
      <span class="result-value" id="retailPrice">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">实际毛利率：</span>
      <span class="result-value" id="actualMargin">0.00%</span>
    </div>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);
  const inputs = {
    r: el('overheadRate'),
    raw: el('rawMaterial'),
    pack: el('packaging'),
    freight: el('otherFreight'),
    margin: el('profitMargin'),
    disc: el('discount')
  };
  const outputs = {
    manu: el('manufacturingCost'),
    cost: el('totalCost'),
    price: el('factoryPrice'),
    retail: el('retailPrice'),
    marginActual: el('actualMargin'),
    error: el('errorMessage')
  };

  function getNum(input) {
    const v = parseFloat(input.value);
    return isNaN(v) ? 0 : v;
  }

  function recalculate() {
    const r = getNum(inputs.r) / 100;
    const raw = getNum(inputs.raw);
    const pack = getNum(inputs.pack);
    const freight = getNum(inputs.freight);
    const margin = getNum(inputs.margin) / 100;
    const disc = getNum(inputs.disc) / 100;

    // 隐藏错误
    outputs.error.classList.add('hidden');

    // 检查分母
    const denominator = 1 - margin - r;
    if (denominator <= 0) {
      outputs.error.textContent = '错误：毛利率 + 制费系数 ≥ 100%，无法计算出厂价';
      outputs.error.classList.remove('hidden');
      return;
    }

    // 出厂价 P = [ (A+B)/(1+r) + F ] / (1 - margin - r)
    const numerator = (raw + pack) / (1 + r) + freight;
    const factoryPrice = numerator / denominator;

    // 制造费用合计 = P * r
    const manufacturingCost = factoryPrice * r;

    // 合计成本 = P * (1 - margin)
    const totalCost = factoryPrice * (1 - margin);

    // 零售价 = P / (1 - disc)
    const retailPrice = disc < 1 ? factoryPrice / (1 - disc) : Infinity;

    // 实际毛利率（应等于 margin，用于验证）
    const actualMargin = factoryPrice > 0 ? (factoryPrice - totalCost) / factoryPrice : 0;

    // 更新 UI
    outputs.manu.value = manufacturingCost.toFixed(2);
    outputs.cost.textContent = totalCost.toFixed(2);
    outputs.price.textContent = factoryPrice.toFixed(2);
    outputs.retail.textContent = isFinite(retailPrice) ? retailPrice.toFixed(2) : '—';
    outputs.marginActual.textContent = (actualMargin * 100).toFixed(2) + '%';
  }

  // 绑定事件
  Object.values(inputs).forEach(inp => inp.addEventListener('input', recalculate));

  recalculate();
</script>

</body>
</html>
