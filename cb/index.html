<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>成本核算</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <style>
    .input-row { @apply flex flex-wrap gap-4 mb-5; }
    .input-col { @apply flex-1 min-w-[130px]; }
    .label { @apply block text-sm font-medium text-gray-700 mb-1; }
    .result-box { @apply mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg; }
    .result-row { @apply flex justify-between py-1.5; }
    .result-label { @apply font-medium text-gray-700; }
    .result-value { @apply font-bold text-blue-700; }
    .error { @apply text-red-600 font-semibold mt-2; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

<div class="max-w-7xl mx-auto bg-white shadow rounded-xl p-6 my-6">

  <!-- 成本核算小标题 -->
  <h2 class="text-xl font-bold text-blue-600 mb-4">成本核算</h2>

  <!-- 项目号 & 产品名称 -->
  <div class="input-row mb-6">
    <div class="input-col">
      <label class="label">项目号</label>
      <input type="text" id="projectNumber"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" placeholder="请输入项目号" />
    </div>
    <div class="input-col">
      <label class="label">产品名称</label>
      <input type="text" id="productName"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" placeholder="请输入产品名称" />
    </div>
  </div>

  <!-- 第1行：制费系数、原料、包材、其他运费 -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">制费系数 (%)</label>
      <input type="number" step="0.01" id="overheadRate" value="12"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" />
    </div>
    <div class="input-col">
      <label class="label">原料（含税）</label>
      <input type="number" step="0.01" id="rawMaterial"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" placeholder="0.00" />
    </div>
    <div class="input-col">
      <label class="label">包材（含税）</label>
      <input type="number" step="0.01" id="packaging"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" placeholder="0.00" />
    </div>
    <div class="input-col">
      <label class="label">其他运费</label>
      <input type="number" step="0.01" id="otherFreight"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" placeholder="0.00" />
    </div>
  </div>

  <!-- 第2行：制造费用合计（人工+折旧+制费） -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">制造费用合计<br><span class="text-xs text-gray-500">(人工+折旧+制费)</span></label>
      <input type="text" id="manufacturingCost" readonly
        class="w-full bg-gray-100 border border-gray-300 rounded-lg p-2 cursor-not-allowed" />
    </div>
  </div>

  <!-- 第3行：市场定价毛利率、折扣 -->
  <div class="input-row">
    <div class="input-col">
      <label class="label">市场定价毛利率 (%)</label>
      <input type="number" step="0.01" id="profitMargin" value="15"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" />
    </div>
    <div class="input-col">
      <label class="label">折扣 (%)</label>
      <input type="number" step="0.01" id="discount" value="45"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400" />
    </div>
  </div>

  <!-- 错误提示 -->
  <div id="errorMessage" class="error hidden"></div>

  <!-- 计算结果区 -->
  <div class="result-box">
    <div class="result-row">
      <span class="result-label">合计成本（不含税）：</span>
      <span class="result-value" id="totalCost">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">出厂价：</span>
      <span class="result-value" id="factoryPrice">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">市场零售价：</span>
      <span class="result-value" id="retailPrice">0.00</span>
    </div>
    <div class="result-row">
      <span class="result-label">实际毛利率：</span>
      <span class="result-value" id="actualMargin">0.00%</span>
    </div>
  </div>

  <!-- 导出按钮 -->
  <div class="mt-6 flex justify-end">
    <button id="exportButton"
      class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus:outline-none">
      导出为 Excel
    </button>
  </div>
</div>

<script>
  const el = id => document.getElementById(id);

  // 输入元素
  const inputs = {
    projectNumber: el('projectNumber'),
    productName: el('productName'),
    r: el('overheadRate'),
    raw: el('rawMaterial'),
    pack: el('packaging'),
    freight: el('otherFreight'),
    margin: el('profitMargin'),
    disc: el('discount')
  };

  // 输出元素
  const outputs = {
    manu: el('manufacturingCost'),
    cost: el('totalCost'),
    price: el('factoryPrice'),
    retail: el('retailPrice'),
    actual: el('actualMargin'),
    error: el('errorMessage')
  };

  // 安全转数字
  function toNum(input) {
    const v = parseFloat(input.value);
    return isNaN(v) ? 0 : v;
  }

  // 核心计算函数
  function recalculate() {
    const r = toNum(inputs.r) / 100;           // 制费系数（小数）
    const raw = toNum(inputs.raw);             // 原料
    const pack = toNum(inputs.pack);           // 包材
    const freight = toNum(inputs.freight);     // 其他运费
    const margin = toNum(inputs.margin) / 100; // 毛利率（小数）
    const disc = toNum(inputs.disc) / 100;     // 折扣率（小数）

    // 清除错误
    outputs.error.classList.add('hidden');

    // 出厂价公式（你提供的）
    const numerator = (raw + pack) / (1 + r) + freight;
    const denominator = (1 - margin) / (1 + r) - r;

    if (Math.abs(denominator) < 1e-8) {
      outputs.error.textContent = '计算错误：分母接近零，请检查毛利率与制费系数设置';
      outputs.error.classList.remove('hidden');
      return;
    }

    const factoryPrice = numerator / denominator;

    // 制造费用合计 = 出厂价 × 制费系数
    const manufacturingCost = factoryPrice * r;

    // 合计成本（不含税） = (原料+包材)/(1+r) + 其他运费 + 制造费用合计
    const totalCost = (raw + pack) / (1 + r) + freight + manufacturingCost;

    // 市场零售价 = 出厂价 / (1 - 折扣率) —— 更符合商业逻辑（45%折扣 = 打55折）
    const retailPrice = disc < 1 ? factoryPrice / (1 - disc) : Infinity;

    // 实际毛利率 = [出厂价/(1+r) - 合计成本] / 出厂价 * (1+r)
    const actualMargin = factoryPrice !== 0
      ? ((factoryPrice / (1 + r) - totalCost) / factoryPrice) * (1 + r)
      : 0;

    // 更新界面
    outputs.manu.value = manufacturingCost.toFixed(2);
    outputs.cost.textContent = totalCost.toFixed(2);
    outputs.price.textContent = factoryPrice.toFixed(2);
    outputs.retail.textContent = isFinite(retailPrice) ? retailPrice.toFixed(2) : '—';
    outputs.actual.textContent = (actualMargin * 100).toFixed(2) + '%';
  }

  // 绑定实时计算
  Object.values(inputs).forEach(inp => inp.addEventListener('input', recalculate));

  // 初始化
  recalculate();

  // 导出 Excel
  el('exportButton').addEventListener('click', () => {
    const data = [
      ['字段', '值'],
      ['项目号', inputs.projectNumber.value || '—'],
      ['产品名称', inputs.productName.value || '—'],
      ['制费系数 (%)', inputs.r.value],
      ['原料（含税）', inputs.raw.value],
      ['包材（含税）', inputs.pack.value],
      ['其他运费', inputs.freight.value],
      ['制造费用合计', outputs.manu.value],
      ['市场定价毛利率 (%)', inputs.margin.value],
      ['折扣 (%)', inputs.disc.value],
      ['合计成本（不含税）', outputs.cost.textContent],
      ['出厂价', outputs.price.textContent],
      ['市场零售价', outputs.retail.textContent],
      ['实际毛利率', outputs.actual.textContent]
    ];

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '成本核算结果');
    const filename = (inputs.productName.value || '成本核算') + '.xlsx';
    XLSX.writeFile(wb, filename);
  });
</script>

</body>
</html>
